# 2048 - Game Design Document

## Overview

**2048** is a single-player sliding tile puzzle game where players combine numbered tiles on a 4x4 grid to create a tile with the value 2048. Originally created by Gabriele Cirulli in 2014, it became a viral sensation because of its simple mechanics but addictive "just one more try" gameplay.

**Why Kids Love It:**
- **Simple rules** - swipe in a direction, matching numbers merge
- **Satisfying combos** - watching 64+64=128 never gets old
- **Quick sessions** - games last 2-5 minutes
- **Math practice** - powers of 2, without feeling like homework
- **"Beat my high score"** - instant replay motivation
- **No time pressure** - think as long as you want

**Target Player**: Hank Neil (age 8) and kids 6-14
**Platform**: Web (mobile + desktop)
**Style**: Colorful tiles with smooth animations, kid-friendly

---

## Core Loop

```
SWIPE (or arrow key) in a direction
    |
    v
ALL TILES slide in that direction
    |
    v
MATCHING tiles merge (2+2=4, 4+4=8, etc.)
    |
    v
NEW TILE spawns (2 or 4)
    |
    v
CHECK: Can any move be made?
    |
    +--> YES: Continue playing
    |
    +--> NO: Game Over!
    |
GOAL: Create a 2048 tile (or keep going for higher!)
```

### Why This Loop Works

Based on 2048's viral success (100M+ plays):
- **Instant understanding** - rules learned in 10 seconds
- **Variable reward** - sometimes you get lucky combos, sometimes not
- **Clear progress** - watch numbers grow from 2 to 2048
- **No punishment for failure** - just start over instantly
- **"Almost had it!"** - getting close to 2048 drives replay
- **Endless ceiling** - after 2048, chase 4096, 8192, etc.

---

## Controls

### Mobile (Touch/Swipe)

```
+-----------------------------------------+
|                                         |
|   [SCORE: 1,234]     [BEST: 5,678]      |
|                                         |
|   +---+---+---+---+                     |
|   | 2 | 4 |   | 2 |                     |
|   +---+---+---+---+                     |
|   | 8 | 16|   |   |  <-- SWIPE ANYWHERE |
|   +---+---+---+---+      ON THE GRID    |
|   |   | 2 | 4 |   |                     |
|   +---+---+---+---+                     |
|   | 4 | 8 | 16| 32|                     |
|   +---+---+---+---+                     |
|                                         |
|   [UNDO]      [NEW GAME]                |
|                                         |
+-----------------------------------------+
```

**Swipe Controls:**
- Swipe UP = all tiles slide up
- Swipe DOWN = all tiles slide down
- Swipe LEFT = all tiles slide left
- Swipe RIGHT = all tiles slide right

**Touch Targets:**
- Entire grid is swipe zone (no tiny buttons)
- UNDO and NEW GAME buttons are 60x60px minimum
- Gesture detection with 30px minimum swipe distance

### Desktop (Keyboard)

| Key | Action |
|-----|--------|
| Arrow Up / W | Slide all tiles up |
| Arrow Down / S | Slide all tiles down |
| Arrow Left / A | Slide all tiles left |
| Arrow Right / D | Slide all tiles right |
| Z (or Ctrl+Z) | Undo last move |
| N | New Game |

---

## Progression System

### Scoring

Every merge adds points:
- **Base formula**: Points = value of the merged tile
- Example: 2+2=4 scores **4 points**
- Example: 512+512=1024 scores **1024 points**
- Chain merges in a single swipe add up

### Milestones (Tile Achievements)

| Tile | Achievement Name | First Time Reward |
|------|------------------|-------------------|
| 128 | Getting Warm! | Confetti animation |
| 256 | Halfway There! | Bigger confetti |
| 512 | So Close! | Particle explosion |
| 1024 | Almost! | Screen shake + confetti |
| 2048 | WINNER! | Full celebration (confetti, fireworks, sound) |
| 4096 | Beyond Master | Special badge |
| 8192 | Legendary | Ultra-rare badge |

### Persisted Stats

The following data is saved per user:

```typescript
interface Game2048State {
  // Required for sync
  updatedAt: number;            // Unix timestamp

  // Game progress
  highScore: number;            // Best score ever
  highestTile: number;          // Best tile reached (2048, 4096, etc.)
  gamesPlayed: number;          // Total games started
  gamesWon: number;             // Games where 2048 was reached

  // Current game (for resume)
  currentGame: {
    grid: number[][];           // 4x4 grid state
    score: number;              // Current score
    gameOver: boolean;          // Is game ended?
    won: boolean;               // Has 2048 been reached?
    moveHistory: MoveSnapshot[]; // For undo (last 5 moves max)
  } | null;

  // Preferences
  preferences: {
    soundEnabled: boolean;
    showAnimations: boolean;
    colorTheme: 'classic' | 'colorful' | 'dark';
  };
}
```

---

## Features (Priority Order)

### MVP (Phase 1) - Core Gameplay

- [ ] 4x4 grid with tile sliding mechanics
- [ ] Tile merging logic (2+2=4, 4+4=8, etc.)
- [ ] New tile spawning (90% chance of 2, 10% chance of 4)
- [ ] Win detection (2048 tile created)
- [ ] Game over detection (no valid moves)
- [ ] Score tracking (current + high score)
- [ ] Swipe controls for mobile
- [ ] Arrow key controls for desktop
- [ ] New Game button
- [ ] Basic tile colors

### Phase 2 - Polish

- [ ] Smooth tile sliding animations (CSS transitions)
- [ ] Tile merge pop animation
- [ ] Tile spawn animation (scale from 0)
- [ ] Undo button (last 5 moves)
- [ ] Sound effects (merge, slide, game over, win)
- [ ] Celebration on reaching 2048
- [ ] "Keep Playing" option after winning
- [ ] Responsive layout (mobile + desktop)

### Phase 3 - Persistence

- [ ] Save current game to localStorage
- [ ] Resume game on page load
- [ ] Integrate useAuthSync hook for logged-in users
- [ ] High score persistence
- [ ] Stats tracking (games played, games won, highest tile)

### Phase 4 - Kid-Friendly Extras

- [ ] Color theme options (classic, colorful, dark mode)
- [ ] Larger tile option for young kids
- [ ] Confetti on milestones (128, 256, 512, 1024, 2048)
- [ ] Achievement badges
- [ ] Share score button (copy to clipboard)

### Nice-to-Have (Future)

- [ ] Different grid sizes (3x3 easy, 5x5 hard)
- [ ] Daily challenge mode
- [ ] Leaderboard (if multiplayer ever added)
- [ ] Undo animation (tiles slide back)

---

## Technical Approach

### Stack

```
Next.js 16 + React 19
TypeScript
CSS Grid or Flexbox for layout
CSS transitions/animations for tile movement
Zustand for state management
useAuthSync hook for persistence
```

### Why Not Canvas?

For 2048, CSS Grid with transitions is simpler and sufficient:
- 16 tiles max on screen
- Animations are sliding, not complex physics
- Easier to style and theme
- Better accessibility (screen readers can read tiles)
- Performant on all devices

Canvas would be overkill and add complexity without benefit.

### Core Game Logic

The game logic is pure TypeScript with no React dependencies:

```typescript
// Slide tiles in a direction, return new grid + score gained
function slideTiles(grid: number[][], direction: Direction): {
  grid: number[][];
  scoreGained: number;
  moved: boolean;
}

// Check if any valid move exists
function hasValidMoves(grid: number[][]): boolean;

// Spawn a new tile (2 or 4) in random empty cell
function spawnTile(grid: number[][]): number[][];

// Check if 2048 tile exists (win condition)
function hasWon(grid: number[][]): boolean;
```

---

## Code Sources

### Primary Reference: Original 2048

**GitHub**: https://github.com/gabrielecirulli/2048

- **License**: MIT (fully open source, can be used freely)
- **Why reference it**: The original by Gabriele Cirulli, clean implementation
- **Key files to study**:
  - `js/game_manager.js` - Core game logic
  - `js/grid.js` - Grid manipulation
  - `js/tile.js` - Tile class
  - `js/html_actuator.js` - DOM updates (we'll use React instead)
  - `js/keyboard_input_manager.js` - Input handling
  - `style/main.css` - Tile colors and animations

### Other References

| Repo | URL | Notes |
|------|-----|-------|
| Original 2048 | https://github.com/gabrielecirulli/2048 | MIT license, the gold standard |
| React 2048 | https://github.com/mateuszsokol/react-2048 | React implementation example |
| React 2048 (Hooks) | https://github.com/andyxq/react-2048 | Modern hooks-based example |
| TypeScript 2048 | https://github.com/nickovchinnikov/2048 | TypeScript implementation |

### Tile Color Reference (from original)

```css
/* Classic 2048 colors */
.tile-2    { background: #eee4da; color: #776e65; }
.tile-4    { background: #ede0c8; color: #776e65; }
.tile-8    { background: #f2b179; color: #f9f6f2; }
.tile-16   { background: #f59563; color: #f9f6f2; }
.tile-32   { background: #f67c5f; color: #f9f6f2; }
.tile-64   { background: #f65e3b; color: #f9f6f2; }
.tile-128  { background: #edcf72; color: #f9f6f2; }
.tile-256  { background: #edcc61; color: #f9f6f2; }
.tile-512  { background: #edc850; color: #f9f6f2; }
.tile-1024 { background: #edc53f; color: #f9f6f2; }
.tile-2048 { background: #edc22e; color: #f9f6f2; }
```

---

## Kid-Friendly Design

### Visual Design

- **Large tiles** - At least 80x80px on mobile, 120x120px on desktop
- **Bold numbers** - Font size 32-48px, easy to read
- **High contrast** - Dark text on light tiles (or vice versa)
- **Smooth animations** - 150ms transitions, satisfying to watch
- **Colorful theme option** - Alternative to classic beige (rainbow tiles)

### Touch Friendly

- **Generous swipe zone** - The entire grid area accepts swipes
- **Visual feedback** - Tiles react instantly on swipe
- **Accidental tap protection** - Require 30px minimum swipe distance
- **Big buttons** - UNDO and NEW GAME are 60x60px minimum

### Celebration & Feedback

| Event | Feedback |
|-------|----------|
| Tile merge | Pop animation (scale up then down) |
| New tile spawn | Fade + scale in from 0 |
| Reach 128 | Small confetti burst |
| Reach 256 | Medium confetti |
| Reach 512 | Large confetti + "Nice!" message |
| Reach 1024 | Screen shake + confetti |
| Reach 2048 | Full celebration (fireworks, confetti, "YOU WIN!") |
| Game Over | Sad face, gentle shake, "Try Again?" prompt |

### Sound Effects

| Event | Sound |
|-------|-------|
| Tile slide | Soft whoosh |
| Tile merge | Pop/click |
| New tile spawn | Subtle ping |
| Win (2048) | Victory fanfare |
| Game over | Gentle "womp womp" |
| Undo | Rewind sound |
| Button tap | Click |

### Forgiving Gameplay

- **Unlimited undo** - Kids make mistakes, let them take it back
- **Auto-save** - Never lose progress on accidental close
- **No time pressure** - No timer, no rush
- **Continue after winning** - Reach 2048? Keep going for 4096!

---

## File Structure

Following the compartmentalized pattern from CLAUDE.md:

```
apps/web/src/
├── app/
│   └── games/
│       └── 2048/
│           └── page.tsx              # Just imports from src/games/2048
│
├── games/
│   └── 2048/                         # SELF-CONTAINED game module
│       ├── components/
│       │   ├── Grid.tsx              # 4x4 grid container
│       │   ├── Tile.tsx              # Individual tile with animations
│       │   ├── Controls.tsx          # NEW GAME, UNDO buttons
│       │   ├── ScoreBoard.tsx        # Current score + high score
│       │   ├── GameOver.tsx          # Game over overlay
│       │   └── WinScreen.tsx         # Win celebration overlay
│       │
│       ├── hooks/
│       │   ├── useSwipe.ts           # Touch swipe detection
│       │   ├── useKeyboard.ts        # Arrow key handling
│       │   └── useGamePersistence.ts # localStorage + auth sync
│       │
│       ├── lib/
│       │   ├── store.ts              # Zustand store (grid, score, etc.)
│       │   ├── gameLogic.ts          # Pure functions (slide, merge, spawn)
│       │   ├── constants.ts          # Tile colors, animation timings
│       │   └── sounds.ts             # Sound effect handlers
│       │
│       ├── styles/
│       │   └── tiles.css             # Tile colors and animations
│       │
│       ├── __tests__/
│       │   ├── gameLogic.test.ts     # Unit tests for game logic
│       │   └── Game.test.tsx         # Component rendering tests
│       │
│       ├── Game.tsx                  # Main game component
│       └── index.ts                  # Exports
│
└── public/
    └── games/
        └── 2048/
            └── sounds/
                ├── merge.mp3
                ├── slide.mp3
                ├── spawn.mp3
                ├── win.mp3
                └── gameover.mp3
```

### Route File (Thin)

```typescript
// apps/web/src/app/games/2048/page.tsx
import dynamic from 'next/dynamic';

const Game2048 = dynamic(
  () => import('@/games/2048').then(mod => mod.Game),
  { ssr: false }
);

export default function Page() {
  return <Game2048 />;
}
```

---

## User Data & Persistence

### App ID

```
appId: "2048"
```

### VALID_APP_IDS Update

Add `"2048"` to `packages/db/src/schema/app-progress.ts`:

```typescript
export const VALID_APP_IDS = [
  "hill-climb",
  "monster-truck",
  "weather",
  "2048",  // <-- Add this
] as const;
```

### What to Save

| Field | Type | Description |
|-------|------|-------------|
| `updatedAt` | `number` | Unix timestamp for merge resolution |
| `highScore` | `number` | Best score ever achieved |
| `highestTile` | `number` | Best tile reached (2048, 4096, etc.) |
| `gamesPlayed` | `number` | Total games started |
| `gamesWon` | `number` | Games where 2048 was reached |
| `currentGame` | `object | null` | Game state for resume |
| `preferences` | `object` | Sound, animations, theme |

### useAuthSync Integration

```typescript
// games/2048/hooks/useGamePersistence.ts
import { useAuthSync } from '@/shared/hooks/useAuthSync';
import { useGameStore } from '../lib/store';

export function useGamePersistence() {
  const getState = useGameStore((state) => state.getPersistedState);
  const setState = useGameStore((state) => state.setPersistedState);

  const { isGuest, syncStatus, lastSynced, forceSync } = useAuthSync({
    appId: '2048',
    localStorageKey: '2048-game-state',
    getState,
    setState,
    debounceMs: 2000,
  });

  return { isGuest, syncStatus, lastSynced, forceSync };
}
```

### Behavior Summary

| User Type | Storage | Sync |
|-----------|---------|------|
| Guest | localStorage only | None |
| Logged In | localStorage + Database | Auto-save every 2s |

- **On login**: Merges localStorage with DB (takes higher high score)
- **On logout**: Clears localStorage
- **On page close**: Current game saved to localStorage for resume

---

## Implementation Phases

### Phase 1: Core Game (MVP)

**Goal**: Playable 2048 with basic UI

1. Create file structure under `apps/web/src/games/2048/`
2. Implement `gameLogic.ts` (slide, merge, spawn, win/lose detection)
3. Write unit tests for game logic
4. Build `Grid.tsx` and `Tile.tsx` components
5. Add keyboard controls (arrow keys)
6. Add swipe controls (touch)
7. Display score and high score
8. Add NEW GAME button
9. Add UNDO functionality

**Deliverable**: A working 2048 game

### Phase 2: Polish

**Goal**: Smooth, satisfying gameplay feel

1. Add CSS transitions for tile sliding
2. Add tile merge pop animation
3. Add tile spawn animation
4. Add sound effects
5. Add confetti on milestones (128, 256, 512, 1024)
6. Add win celebration on 2048
7. Add "Keep Playing" option after winning
8. Add game over screen with retry button

**Deliverable**: A polished, fun-to-play game

### Phase 3: Persistence

**Goal**: Save progress across sessions

1. Add "2048" to VALID_APP_IDS
2. Save current game to localStorage on every move
3. Resume game on page load
4. Integrate useAuthSync hook
5. Show GuestWarning and SyncIndicator
6. Test login/logout flow with data sync

**Deliverable**: Progress persists for guests and logged-in users

### Phase 4: Extras

**Goal**: Kid-friendly extras

1. Add colorful theme option
2. Add achievement badges
3. Add share score button
4. Add larger tile option for young kids
5. Add settings menu

**Deliverable**: Complete, kid-friendly experience

---

## Success Metrics

How do we know the game is good?

1. **Hank understands it in < 30 seconds** - rules are obvious
2. **Hank plays for 10+ minutes** - it's actually fun
3. **Hank asks to play again later** - it's memorable
4. **Hank tries to beat his high score** - progression working
5. **Hank shows friends** - it's share-worthy
6. **No frustration** - undo button prevents rage-quits

---

## References

- [Original 2048 by Gabriele Cirulli](https://github.com/gabrielecirulli/2048) - MIT License
- [Play 2048 Online](https://play2048.co/) - Live version
- [2048 Wikipedia](https://en.wikipedia.org/wiki/2048_(video_game)) - Game history
- [React 2048 Example](https://github.com/mateuszsokol/react-2048) - React implementation
- [2048 Game Strategies](https://www.gamified.uk/2048-game-strategy/) - Tips for gameplay
- [CSS Grid Guide](https://css-tricks.com/snippets/css/complete-guide-grid/) - For layout
- [Framer Motion](https://www.framer.com/motion/) - Animation library (optional)
